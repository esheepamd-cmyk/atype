<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>@type — мини‑соцсеть</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #f0f4ff 0, #e9edf1 40%, #dde3ea 100%);
      color: #222;
    }

    a {
      color: #2a5885;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      background: linear-gradient(90deg, #3366ff, #5b8dff);
      color: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .topbar-logo {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.03em;
    }

    .topbar-logo span {
      background: rgba(255, 255, 255, 0.18);
      padding: 4px 10px;
      border-radius: 999px;
    }

    .topbar-search {
      flex: 1;
      max-width: 340px;
      margin: 0 16px;
    }

    .topbar-search input {
      width: 100%;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      outline: none;
      font-size: 14px;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .avatar-small {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #fff;
      color: #3366ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      overflow: hidden;
    }

    .avatar-small img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .topbar-burger {
      display: none;
      margin-right: 8px;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
    }

    .page {
      display: none;
      flex: 1;
    }

    .page-active {
      display: block;
    }

    .page-auth {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 16px;
    }

    .auth-card {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      padding: 24px 24px 20px;
    }

    .auth-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .auth-subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 16px;
    }

    .auth-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .auth-row label {
      font-size: 13px;
      margin-bottom: 4px;
      display: inline-block;
    }

    .auth-field {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    input[type="text"],
    input[type="password"],
    input[type="url"],
    textarea,
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #c9d4e5;
      font-size: 14px;
      outline: none;
      background: #fdfdff;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="url"]:focus,
    textarea:focus,
    select:focus {
      border-color: #4a78ff;
      box-shadow: 0 0 0 2px rgba(74, 120, 255, 0.15);
      background: #fff;
    }

    .auth-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 8px;
    }

    .btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3366ff, #5b8dff);
      color: #fff;
    }

    .btn-secondary {
      background: #e6ecf5;
      color: #2c3e50;
    }

    .btn-danger {
      background: #f44336;
      color: #fff;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .auth-hint {
      font-size: 12px;
      color: #777;
      margin-top: 4px;
      min-height: 16px;
    }

    .app-main {
      padding: 12px 16px 24px;
    }

    .layout {
      display: grid;
      grid-template-columns: 200px minmax(0, 1.2fr) 260px;
      gap: 12px;
      align-items: flex-start;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      margin-bottom: 12px;
      overflow: hidden;
    }

    .card-header {
      padding: 10px 12px;
      border-bottom: 1px solid #e5ebf1;
      font-weight: 600;
      font-size: 14px;
      background: linear-gradient(90deg, rgba(51, 102, 255, 0.06), transparent);
    }

    .card-body {
      padding: 10px 12px;
      font-size: 14px;
    }

    .left-menu {
      background: #f5f7fb;
      border-radius: 12px;
      padding: 8px 0;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
    }

    .left-menu a {
      display: block;
      padding: 8px 16px;
      font-size: 14px;
      color: #2a2f3a;
      text-decoration: none;
    }

    .left-menu a:hover {
      background: #e1e8ff;
    }

    .left-menu a.active {
      background: #3366ff;
      color: #fff;
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #e1e9ff;
      color: #4253af;
      margin-left: 4px;
    }

    .feed-compose {
      margin-bottom: 8px;
    }

    .feed-compose textarea {
      width: 100%;
      resize: vertical;
      min-height: 50px;
      max-height: 140px;
      padding: 8px;
      border-radius: 10px;
    }

    .feed-compose-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 12px;
      color: #777;
    }

    .feed-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .feed-item {
      border-radius: 10px;
      border: 1px solid #e5ebf1;
      padding: 8px 10px;
      background: #fbfcff;
    }

    .feed-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .feed-author {
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }

    .feed-meta {
      font-size: 11px;
      color: #888;
    }

    .feed-text {
      font-size: 14px;
      margin-bottom: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .feed-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: #777;
    }

    .feed-actions {
      display: flex;
      gap: 8px;
    }

    .feed-action {
      background: none;
      border: none;
      color: #2a5885;
      cursor: pointer;
      font-size: 12px;
      padding: 0;
    }

    .feed-empty {
      font-size: 13px;
      color: #777;
      text-align: center;
      padding: 8px 0;
    }

    .feed-filter-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .feed-filter-row input[type="text"] {
      flex: 1;
    }

    .feed-filter-row select {
      width: 130px;
    }

    .dialog-layout {
      display: grid;
      grid-template-columns: 200px minmax(0, 1fr);
      gap: 8px;
    }

    .dialog-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .dialog-item {
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dialog-item:hover {
      background: #eef2ff;
    }

    .dialog-item.active {
      background: #3366ff;
      color: #fff;
    }

    .dialog-item-meta {
      font-size: 11px;
      color: #888;
    }

    .dialog-item .online-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #d7f5dd;
      color: #1b7c33;
      margin-left: 4px;
    }

    .dialog-box {
      border-radius: 10px;
      border: 1px solid #e5ebf1;
      padding: 8px;
      background: #fbfcff;
      display: flex;
      flex-direction: column;
      height: 320px;
    }

    .dialog-messages {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      margin-bottom: 6px;
    }

    .chat-message {
      margin-bottom: 6px;
      font-size: 13px;
    }

    .chat-message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .chat-message-author {
      font-weight: 600;
      font-size: 12px;
    }

    .chat-message-meta {
      font-size: 11px;
      color: #888;
    }

    .chat-message-text {
      white-space: pre-wrap;
      word-wrap: break-word;
      padding: 4px 6px;
      border-radius: 8px;
      background: #eef2ff;
    }

    .chat-message.self .chat-message-text {
      background: #dff5ff;
    }

    .chat-input-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .chat-input-row input {
      flex: 1;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 8px;
    }

    .small {
      font-size: 12px;
      color: #666;
    }

    .profile-block {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }

    .profile-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #f0f3ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      font-weight: 700;
      color: #3366ff;
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .profile-name {
      font-weight: 600;
      font-size: 16px;
    }

    .profile-status {
      font-size: 13px;
      color: #555;
    }

    .friends-list {
      list-style: none;
      margin: 0;
      padding: 0;
      font-size: 14px;
    }

    .friends-list li {
      padding: 4px 0;
      border-bottom: 1px solid #f0f2f7;
    }

    .badge-role {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 4px;
      background: #ffe5b2;
      color: #8a4b00;
    }

    .badge-admin {
      background: #ffe5b2;
      color: #8a4b00;
    }

    .badge-muted {
      background: #ffd6d6;
      color: #9b2c2c;
    }

    .menu-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      z-index: 18;
    }

    .left-menu.mobile {
      position: fixed;
      top: 48px;
      left: 0;
      height: calc(100vh - 48px);
      width: 220px;
      transform: translateX(-100%);
      transition: transform 0.2s ease-out;
      z-index: 19;
      border-radius: 0 12px 12px 0;
    }

    .left-menu.mobile.menu-open {
      transform: translateX(0);
    }

    .right-column {
      font-size: 13px;
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 180px minmax(0, 1.2fr);
      }

      .right-column {
        display: none;
      }
    }

    @media (max-width: 720px) {
      .topbar-burger {
        display: inline-block;
      }

      .layout {
        grid-template-columns: minmax(0, 1fr);
      }

      .left-column {
        display: none;
      }

      .left-menu.mobile {
        display: block;
      }

      .app-main {
        padding: 10px;
      }
    }

    @media (max-width: 480px) {
      .topbar-search {
        display: none;
      }

      .auth-card {
        padding: 18px 16px 14px;
      }

      .auth-row {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="topbar">
      <button class="topbar-burger" id="burgerBtn">☰</button>
      <div class="topbar-logo"><span>@type</span></div>
      <div class="topbar-search">
        <input type="text" id="feedSearchInput" placeholder="Поиск по ленте (внизу)">
      </div>
      <div class="topbar-right" id="topbarUser">
        <div class="avatar-small">?</div>
        <span>Не авторизован</span>
      </div>
    </div>

    <div id="page-auth" class="page page-auth page-active">
      <div class="auth-card">
        <div class="auth-title">Вход или регистрация</div>
        <div class="auth-subtitle">Зайди как существующий пользователь или создай нового.</div>

        <div class="auth-row">
          <div class="auth-field">
            <label for="loginInput">Логин</label>
            <input type="text" id="loginInput" placeholder="например, testa acc">
          </div>
          <div class="auth-field">
            <label for="passwordInput">Пароль</label>
            <input type="password" id="passwordInput" placeholder="пароль">
          </div>
        </div>

        <div class="auth-buttons">
          <button class="btn btn-primary" id="loginBtn">Войти</button>
          <button class="btn btn-secondary" id="registerBtn">Регистрация</button>
        </div>

        <div class="auth-hint" id="authHint">Тестовый админ: логин <b>testa acc</b>, пароль любой.</div>
      </div>
    </div>

    <div id="page-app" class="page">
      <div class="app-main">
        <div class="layout">
          <div class="left-column">
            <nav class="left-menu" id="leftMenu">
              <a href="#" data-nav="news" class="active">Лента</a>
              <a href="#" data-nav="messages">Сообщения</a>
              <a href="#" data-nav="profile">Профиль</a>
              <a href="#" data-nav="settings">Настройки</a>
              <a href="#" id="logoutLink">Выйти</a>
            </nav>
          </div>

          <main>
            <section id="section-news">
              <div class="card">
                <div class="card-header">Лента</div>
                <div class="card-body">
                  <div class="feed-compose">
                    <textarea id="postInput" placeholder="Напишите что-нибудь..."></textarea>
                    <div class="feed-compose-footer">
                      <span id="postHint">Макс. 500 символов.</span>
                      <button class="btn btn-primary" id="addPostBtn">Опубликовать</button>
                    </div>
                  </div>

                  <div class="feed-filter-row">
                    <input type="text" id="inlineFeedSearchInput" placeholder="Фильтр по тексту">
                    <button class="btn btn-secondary" id="feedSearchClearBtn">Сброс</button>
                    <select id="feedFilterSelect">
                      <option value="all">Все посты</option>
                      <option value="friends">Только друзей</option>
                      <option value="mine">Только мои</option>
                    </select>
                  </div>

                  <ul id="feedList" class="feed-list"></ul>
                  <div id="feedEmpty" class="feed-empty" style="display:none;">Постов пока нет.</div>
                </div>
              </div>
            </section>

            <section id="section-messages" style="display:none;">
              <div class="card">
                <div class="card-header">Сообщения</div>
                <div class="card-body">
                  <div class="dialog-layout">
                    <div>
                      <ul id="dialogList" class="dialog-list"></ul>
                    </div>
                    <div>
                      <div class="dialog-box">
                        <div class="dialog-messages" id="chatMessages"></div>
                        <div class="small" id="chatStatus">Выберите диалог слева.</div>
                        <div class="chat-input-row">
                          <input type="text" id="chatInput" placeholder="Напишите сообщение...">
                          <button class="btn btn-primary" id="chatSendBtn">Отправить</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section id="section-profile" style="display:none;">
              <div class="card">
                <div class="card-header">Профиль</div>
                <div class="card-body">
                  <div class="profile-block">
                    <div class="profile-avatar" id="profileAvatar">?</div>
                    <div>
                      <div class="profile-name" id="profileName">Не авторизован</div>
                      <div class="profile-status" id="profileStatus">Статус не задан.</div>
                      <div class="small" id="profileRole"></div>
                    </div>
                  </div>
                  <div class="small" id="profileExtra"></div>
                </div>
              </div>

              <div class="card">
                <div class="card-header">Друзья</div>
                <div class="card-body">
                  <div class="auth-row" style="margin-bottom:6px;">
                    <div class="auth-field">
                      <label for="addFriendInput">Добавить друга по логину</label>
                      <input type="text" id="addFriendInput" placeholder="логин пользователя">
                    </div>
                    <div class="auth-field" style="align-self:flex-end;">
                      <button class="btn btn-secondary" id="addFriendBtn">Добавить</button>
                    </div>
                  </div>
                  <div class="small" id="friendsHint">Введите логин и нажмите «Добавить».</div>
                  <ul id="friendsList" class="friends-list"></ul>
                </div>
              </div>
            </section>

            <section id="section-settings" style="display:none;">
              <div class="card">
                <div class="card-header">Настройки аккаунта</div>
                <div class="card-body">
                  <div class="auth-row">
                    <div class="auth-field">
                      <label for="statusInput">Статус</label>
                      <input type="text" id="statusInput" placeholder="чем вы заняты?">
                    </div>
                    <div class="auth-field" style="align-self:flex-end;">
                      <button class="btn btn-secondary" id="saveStatusBtn">Сохранить статус</button>
                    </div>
                  </div>

                  <div class="auth-row">
                    <div class="auth-field">
                      <label for="avatarInput">Аватар (URL картинки)</label>
                      <input type="url" id="avatarInput" placeholder="https://...">
                    </div>
                    <div class="auth-field" style="align-self:flex-end;">
                      <button class="btn btn-secondary" id="saveAvatarBtn">Сохранить аватар</button>
                    </div>
                  </div>

                  <div class="small" id="settingsHint">Статус и аватар сохраняются локально и на сервере.</div>

                  <hr style="margin:10px 0;border:none;border-top:1px solid #e5ebf1;">

                  <div id="adminPanel" style="display:none;">
                    <div class="small" style="margin-bottom:6px;">
                      Админ‑панель. Видна только тебе.
                    </div>

                    <label for="adminTargetUser">Пользователь для действий</label>
                    <div class="auth-row" style="margin-bottom:6px;">
                      <div class="auth-field">
                        <input type="text" id="adminTargetUser" placeholder="логин пользователя">
                      </div>
                      <div class="auth-field" style="align-self:flex-end;">
                        <button class="btn btn-secondary" id="adminMuteBtn">Mute 30 мин</button>
                      </div>
                    </div>

                    <div class="auth-row" style="margin-bottom:6px;">
                      <div class="auth-field" style="align-self:flex-end;">
                        <button class="btn btn-secondary" id="adminUnmuteBtn">Снять mute</button>
                      </div>
                      <div class="auth-field" style="align-self:flex-end;">
                        <button class="btn btn-danger" id="adminCleanupBtn">Удалить пустые аккаунты</button>
                      </div>
                    </div>

                    <div class="small" id="adminHint">Укажи логин и выбери действие.</div>
                  </div>
                </div>
              </div>
            </section>
          </main>

          <aside class="right-column">
            <div class="card">
              <div class="card-header">Аккаунт</div>
              <div class="card-body" id="accountBox">
                Не авторизован.
              </div>
            </div>

            <div class="card">
              <div class="card-header">Инфо</div>
              <div class="card-body" id="infoBox">
                Не авторизован.
              </div>
            </div>

            <div class="card">
              <div class="card-header">Статистика</div>
              <div class="card-body" id="statsBox">
                Постов: 0<br>
                Лайков: 0
              </div>
            </div>
          </aside>
        </div>
      </div>
    </div>

    <div class="menu-overlay" id="menuOverlay"></div>
  </div>

  <script>
    const API_BASE = 'https://atype-backend.onrender.com';

    const STORAGE_KEY_CURRENT  = 'atype_current_user_net';
    const STORAGE_KEY_STATUSES = 'atype_statuses';
    const STORAGE_KEY_AVATARS  = 'atype_avatars';

    const pageAuth = document.getElementById('page-auth');
    const pageApp  = document.getElementById('page-app');

    const loginInput    = document.getElementById('loginInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn      = document.getElementById('loginBtn');
    const registerBtn   = document.getElementById('registerBtn');
    const authHint      = document.getElementById('authHint');

    const logoutLink = document.getElementById('logoutLink');

    const sectionNews     = document.getElementById('section-news');
    const sectionMessages = document.getElementById('section-messages');
    const sectionProfile  = document.getElementById('section-profile');
    const sectionSettings = document.getElementById('section-settings');

    const postInput      = document.getElementById('postInput');
    const postHint       = document.getElementById('postHint');
    const addPostBtn     = document.getElementById('addPostBtn');
    const feedList       = document.getElementById('feedList');
    const feedEmpty      = document.getElementById('feedEmpty');
    const inlineFeedSearchInput = document.getElementById('inlineFeedSearchInput');
    const feedSearchInput       = document.getElementById('feedSearchInput');
    const feedSearchClearBtn    = document.getElementById('feedSearchClearBtn');
    const feedFilterSelect      = document.getElementById('feedFilterSelect');

    const dialogList   = document.getElementById('dialogList');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput    = document.getElementById('chatInput');
    const chatSendBtn  = document.getElementById('chatSendBtn');
    const chatStatus   = document.getElementById('chatStatus');

    const profileAvatar = document.getElementById('profileAvatar');
    const profileName   = document.getElementById('profileName');
    const profileStatus = document.getElementById('profileStatus');
    const profileRole   = document.getElementById('profileRole');
    const profileExtra  = document.getElementById('profileExtra');

    const addFriendInput = document.getElementById('addFriendInput');
    const addFriendBtn   = document.getElementById('addFriendBtn');
    const friendsHint    = document.getElementById('friendsHint');
    const friendsList    = document.getElementById('friendsList');

    const statusInput     = document.getElementById('statusInput');
    const avatarInput     = document.getElementById('avatarInput');
    const saveStatusBtn   = document.getElementById('saveStatusBtn');
    const saveAvatarBtn   = document.getElementById('saveAvatarBtn');
    const settingsHint    = document.getElementById('settingsHint');

    const adminPanel       = document.getElementById('adminPanel');
    const adminTargetUser  = document.getElementById('adminTargetUser');
    const adminMuteBtn     = document.getElementById('adminMuteBtn');
    const adminUnmuteBtn   = document.getElementById('adminUnmuteBtn');
    const adminCleanupBtn  = document.getElementById('adminCleanupBtn');
    const adminHint        = document.getElementById('adminHint');

    const accountBox = document.getElementById('accountBox');
    const infoBox    = document.getElementById('infoBox');
    const statsBox   = document.getElementById('statsBox');

    const leftMenu    = document.getElementById('leftMenu');
    const burgerBtn   = document.getElementById('burgerBtn');
    const menuOverlay = document.getElementById('menuOverlay');
    const topbarUser  = document.getElementById('topbarUser');

    let currentUser = null;
    let feedData    = [];
    let dialogsData = [];
    let friendsData = [];
    let currentDialogUser = null;
    let lastDialogsFetch  = 0;

    function simpleHash(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) {
        h = ((h << 5) - h) + str.charCodeAt(i);
        h |= 0;
      }
      return h.toString();
    }

    function saveCurrentUser(login) {
      currentUser = login;
      if (login) {
        localStorage.setItem(STORAGE_KEY_CURRENT, login);
      } else {
        localStorage.removeItem(STORAGE_KEY_CURRENT);
      }
    }

    function loadStatuses() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_STATUSES);
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    }

    function saveStatuses(obj) {
      localStorage.setItem(STORAGE_KEY_STATUSES, JSON.stringify(obj));
    }

    function loadAvatars() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_AVATARS);
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    }

    function saveAvatars(obj) {
      localStorage.setItem(STORAGE_KEY_AVATARS, JSON.stringify(obj));
    }

    function firstLetter(login) {
      if (!login) return '?';
      return login.trim()[0].toUpperCase();
    }

    function formatTime(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return '';
      return d.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function isAdminUser(login) {
      return login === 'testa acc';
    }

    function openMenu() {
      if (window.innerWidth > 720) return;
      leftMenu.classList.add('mobile');
      leftMenu.classList.add('menu-open');
      menuOverlay.style.display = 'block';
    }

    function closeMenu() {
      leftMenu.classList.remove('menu-open');
      menuOverlay.style.display = 'none';
    }

    function renderAuthState() {
      if (!currentUser) {
        pageAuth.classList.add('page-active');
        pageApp.classList.remove('page-active');
        topbarUser.innerHTML = '<div class="avatar-small">?</div><span>Не авторизован</span>';
        accountBox.textContent = 'Не авторизован.';
        infoBox.textContent    = 'Не авторизован.';
        statsBox.innerHTML     = 'Постов: 0<br>Лайков: 0';
        adminPanel.style.display = 'none';
        return;
      }

      pageAuth.classList.remove('page-active');
      pageApp.classList.add('page-active');

      const statuses = loadStatuses();
      const avatars  = loadAvatars();
      const status = statuses[currentUser] || 'Статус не задан.';
      const avatarUrl = avatars[currentUser] || '';

      const avatarHtmlTop = avatarUrl
        ? '<div class="avatar-small"><img src="' + avatarUrl + '" alt=""></div>'
        : '<div class="avatar-small">' + firstLetter(currentUser) + '</div>';

      topbarUser.innerHTML =
        avatarHtmlTop +
        '<span>' + currentUser + (isAdminUser(currentUser) ? ' (admin)' : '') + '</span>';

      const avatarHtmlProfile = avatarUrl
        ? '<img src="' + avatarUrl + '" alt="">'
        : firstLetter(currentUser);

      profileAvatar.innerHTML = avatarHtmlProfile;
      profileName.textContent = currentUser;
      profileStatus.textContent = status;
      profileRole.textContent = isAdminUser(currentUser)
        ? 'Роль: администратор.'
        : 'Роль: обычный пользователь.';

      accountBox.innerHTML =
        'Логин: <b>' + currentUser + '</b><br>' +
        'Роль: ' + (isAdminUser(currentUser) ? 'admin' : 'user') + '<br>' +
        'Статус: ' + status;

      infoBox.innerHTML =
        'Вы вошли как <b>' + currentUser + '</b>.<br>' +
        'Админ‑панель доступна только тестовому администратору.';

      adminPanel.style.display = isAdminUser(currentUser) ? 'block' : 'none';
    }

    async function handleRegister() {
      const login = (loginInput.value || '').trim();
      const password = passwordInput.value || '';
      if (!login || !password) {
        authHint.textContent = 'Укажи логин и пароль.';
        return;
      }

      authHint.textContent = 'Регистрируем...';
      try {
        const resp = await fetch(API_BASE + '/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            login,
            passwordHash: simpleHash(password)
          })
        });
        const data = await resp.json();
        if (!resp.ok) {
          authHint.textContent = data.error || 'Ошибка регистрации.';
          return;
        }
        authHint.textContent = 'Готово, теперь можешь войти.';
      } catch {
        authHint.textContent = 'Сервер недоступен.';
      }
    }

    async function handleLogin() {
      const login = (loginInput.value || '').trim();
      const password = passwordInput.value || '';
      if (!login || !password) {
        authHint.textContent = 'Укажи логин и пароль.';
        return;
      }

      authHint.textContent = 'Входим...';
      try {
        const resp = await fetch(API_BASE + '/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            login,
            passwordHash: simpleHash(password)
          })
        });
        const data = await resp.json();
        if (!resp.ok) {
          authHint.textContent = data.error || 'Ошибка входа.';
          return;
        }

        saveCurrentUser(login);
        loginInput.value = '';
        passwordInput.value = '';
        authHint.textContent = '';

        await fetchAndRenderPosts();
        await fetchFeed();
        await fetchDialogs();
        await fetchFriends();
        showSection('news');
      } catch {
        authHint.textContent = 'Сервер недоступен.';
      }
    }

    function handleLogout() {
      saveCurrentUser(null);
      feedData = [];
      dialogsData = [];
      friendsData = [];
      currentDialogUser = null;
      chatMessages.innerHTML = '';
      chatStatus.textContent = 'Выберите диалог слева.';
      renderAuthState();
    }

    function renderFeed() {
      const textFilter = (inlineFeedSearchInput.value || '').toLowerCase();
      const mode = feedFilterSelect.value;

      const filtered = feedData.filter(post => {
        if (mode === 'friends' && !post.fromFriend) return false;
        if (mode === 'mine' && post.author !== currentUser) return false;
        if (textFilter && !post.text.toLowerCase().includes(textFilter)) return false;
        return true;
      });

      feedList.innerHTML = '';
      if (!filtered.length) {
        feedEmpty.style.display = 'block';
        return;
      }
      feedEmpty.style.display = 'none';

      filtered.forEach(post => {
        const li = document.createElement('li');
        li.className = 'feed-item';

        const header = document.createElement('div');
        header.className = 'feed-item-header';
        const author = document.createElement('span');
        author.className = 'feed-author';
        author.textContent = post.author;
        header.appendChild(author);

        const meta = document.createElement('span');
        meta.className = 'feed-meta';
        let metaText = formatTime(post.createdAt);
        if (post.author === currentUser) {
          metaText += ' · вы';
        } else if (post.fromFriend) {
          metaText += ' · друг';
        }
        if (post.authorRole === 'admin') {
          metaText += ' · admin';
        }
        meta.textContent = metaText;
        header.appendChild(meta);

        const text = document.createElement('div');
        text.className = 'feed-text';
        text.textContent = post.text;

        const footer = document.createElement('div');
        footer.className = 'feed-footer';
        const infoSpan = document.createElement('span');
        infoSpan.textContent = 'id: ' + post.id;
        footer.appendChild(infoSpan);

        const actions = document.createElement('div');
        actions.className = 'feed-actions';

        if (post.author === currentUser || isAdminUser(currentUser)) {
          const btnDel = document.createElement('button');
          btnDel.className = 'feed-action';
          btnDel.textContent = 'Удалить';
          btnDel.addEventListener('click', () => handleDeletePost(post.id));
          actions.appendChild(btnDel);
        }

        footer.appendChild(actions);

        li.appendChild(header);
        li.appendChild(text);
        li.appendChild(footer);

        feedList.appendChild(li);
      });
    }

    async function fetchFeed() {
      if (!currentUser) return;
      try {
        const resp = await fetch(API_BASE + '/api/posts/feed?login=' + encodeURIComponent(currentUser));
        const data = await resp.json();
        if (!resp.ok) {
          console.error('feed error', data);
          return;
        }
        feedData = data.posts || [];
        renderFeed();
        updateStatsFromFeed();
      } catch (e) {
        console.error(e);
      }
    }

    async function fetchAndRenderPosts() {
      return fetchFeed();
    }

    function applyFeedFilter() {
      inlineFeedSearchInput.value = feedSearchInput.value;
      renderFeed();
    }

    async function handleAddPost() {
      if (!currentUser) return;
      let text = (postInput.value || '').trim();
      if (!text) {
        postHint.textContent = 'Нечего отправлять.';
        return;
      }
      if (text.length > 500) {
        postHint.textContent = 'Слишком длинный пост (>' + text.length + ' символов).';
        return;
      }

      postHint.textContent = 'Отправляем...';

      try {
        const resp = await fetch(API_BASE + '/api/posts/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            login: currentUser,
            text
          })
        });
        const data = await resp.json();
        if (!resp.ok) {
          alert(data.error || 'Ошибка при создании поста.');
          postHint.textContent = 'Ошибка: ' + (data.error || '');
          return;
        }

        postInput.value = '';
        postHint.textContent = 'Опубликовано.';
        await fetchFeed();
      } catch {
        postHint.textContent = 'Сервер недоступен.';
      }
    }

    async function handleDeletePost(postId) {
      if (!currentUser) return;
      if (!confirm('Удалить пост #' + postId + '?')) return;

      try {
        const resp = await fetch(API_BASE + '/api/posts/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            login: currentUser,
            postId
          })
        });
        const data = await resp.json();
        if (!resp.ok) {
          alert(data.error || 'Ошибка удаления.');
          return;
        }
        await fetchFeed();
      } catch {
        alert('Сервер недоступен.');
      }
    }

    async function fetchDialogs(force = false) {
      if (!currentUser) return;
      const now = Date.now();
      if (!force && now - lastDialogsFetch < 5000) return;
      lastDialogsFetch = now;

      try {
        const resp = await fetch(API_BASE + '/api/messages/dialogs?login=' + encodeURIComponent(currentUser));
        const data = await resp.json();
        if (!resp.ok) {
          console.error('dialogs error', data);
          return;
        }
        dialogsData = data.dialogs || [];
        renderDialogs();
      } catch (e) {
        console.error(e);
      }
    }

    function renderDialogs() {
      dialogList.innerHTML = '';
      if (!dialogsData.length) {
        const li = document.createElement('li');
        li.textContent = 'Диалогов пока нет.';
        li.style.fontSize = '13px';
        li.style.color = '#777';
        dialogList.appendChild(li);
        return;
      }

      dialogsData.forEach(dialog => {
        const li = document.createElement('li');
        li.className = 'dialog-item' + (dialog.user === currentDialogUser ? ' active' : '');
        const left = document.createElement('span');
        left.textContent = dialog.user;
        li.appendChild(left);

        const right = document.createElement('span');
        right.className = 'dialog-item-meta';

        if (dialog.online) {
          const badge = document.createElement('span');
          badge.className = 'online-badge';
          badge.textContent = 'online';
          right.appendChild(badge);
        } else if (dialog.lastTime) {
          right.textContent = formatTime(dialog.lastTime);
        }

        li.appendChild(right);

        li.addEventListener('click', () => {
          currentDialogUser = dialog.user;
          renderDialogs();
          fetchMessagesFor(dialog.user);
        });

        dialogList.appendChild(li);
      });
    }

    async function fetchMessagesFor(user) {
      if (!currentUser || !user) return;
      chatStatus.textContent = 'Загружаем диалог...';

      try {
        const resp = await fetch(API_BASE + '/api/messages/thread?login=' +
          encodeURIComponent(currentUser) +
          '&with=' + encodeURIComponent(user));
        const data = await resp.json();
        if (!resp.ok) {
          chatStatus.textContent = data.error || 'Ошибка загрузки диалога.';
          return;
        }
        renderMessages(user, data.messages || [], data.otherOnline, data.mutedUntil);
      } catch {
        chatStatus.textContent = 'Сервер недоступен.';
      }
    }

    function renderMessages(user, messages, otherOnline, mutedUntil) {
      chatMessages.innerHTML = '';
      if (!messages.length) {
        chatMessages.innerHTML = '<div class="small">Сообщений ещё нет. Напишите первое.</div>';
      } else {
        messages.forEach(msg => {
          const div = document.createElement('div');
          div.className = 'chat-message' + (msg.author === currentUser ? ' self' : '');
          const hdr = document.createElement('div');
          hdr.className = 'chat-message-header';
          const aSpan = document.createElement('span');
          aSpan.className = 'chat-message-author';
          aSpan.textContent = msg.author;
          const mSpan = document.createElement('span');
          mSpan.className = 'chat-message-meta';
          mSpan.textContent = formatTime(msg.createdAt);
          hdr.appendChild(aSpan);
          hdr.appendChild(mSpan);

          const text = document.createElement('div');
          text.className = 'chat-message-text';
          text.textContent = msg.text;

          div.appendChild(hdr);
          div.appendChild(text);
          chatMessages.appendChild(div);
        });
      }

      let status = 'Диалог с ' + user + '. ';
      status += otherOnline ? 'Собеседник онлайн.' : 'Собеседник не в сети.';
      if (mutedUntil) {
        status += ' У вас mute до ' + formatTime(mutedUntil) + '.';
      }
      chatStatus.textContent = status;
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function handleSendMessage() {
      if (!currentUser || !currentDialogUser) return;
      const text = (chatInput.value || '').trim();
      if (!text) return;

      chatStatus.textContent = 'Отправляем...';

      try {
        const resp = await fetch(API_BASE + '/api/messages/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            from: currentUser,
            to: currentDialogUser,
            text
          })
        });
        const data = await resp.json();
        if (!resp.ok) {
          chatStatus.textContent = data.error || 'Ошибка отправки.';
          return;
        }
        chatInput.value = '';
        await fetchMessagesFor(currentDialogUser);
        await fetchDialogs(true);
      } catch {
        chatStatus.textContent = 'Сервер недоступен.';
      }
    }

    async function fetchFriends() {
      if (!currentUser) return;
      try {
        const resp = await fetch(API_BASE + '/api/friends/list?login=' + encodeURIComponent(currentUser));
        const data = await resp.json();
        if (!resp.ok) {
          friendsHint.textContent = data.error || 'Ошибка загрузки друзей.';
          return;
        }
        friendsData = data.friends || [];
        renderFriends();
        updateStatsFromFriends();
      } catch {
        friendsHint.textContent = 'Сервер недоступен.';
      }
    }

    function renderFriends() {
      friendsList.innerHTML = '';
      if (!friendsData.length) {
        friendsList.innerHTML = '<li>Друзей пока нет.</li>';
        return;
      }
      friendsData.forEach(f => {
        const li = document.createElement('li');
        li.textContent = f.login;
        if (f.online) {
          li.innerHTML += ' <span style="color:#1b7c33;">●</span>';
        }
        friendsList.appendChild(li);
      });
    }

    async function handleAddFriend() {
      if (!currentUser) return;
      const friendLogin = (addFriendInput.value || '').trim();
      if (!friendLogin) {
        friendsHint.textContent = 'Укажи логин друга.';
        return;
      }
      friendsHint.textContent = 'Добавляем...';

      try {
        const resp = await fetch(API_BASE + '/api/friends/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            login: currentUser,
            friend: friendLogin
          })
        });
        const data = await resp.json();
        if (!resp.ok) {
          friendsHint.textContent = data.error || 'Ошибка добавления.';
          return;
        }
        friendsHint.textContent = 'Добавлен друг: ' + friendLogin;
        addFriendInput.value = '';
        await fetchFriends();
        await fetchFeed();
      } catch {
        friendsHint.textContent = 'Сервер недоступен.';
      }
    }

    function updateStatsFromFeed() {
      if (!currentUser) {
        statsBox.innerHTML = 'Постов: 0<br>Лайков: 0';
        return;
      }
      const myPosts = feedData.filter(p => p.author === currentUser);
      const friendsPosts = feedData.filter(p => p.fromFriend);
      const total = feedData.length;

      statsBox.innerHTML =
        'Всего постов в ленте: ' + total + '<br>' +
        'Моих постов: ' + myPosts.length + '<br>' +
        'Постов друзей: ' + friendsPosts.length;
    }

    function updateStatsFromFriends() {
      const countFriends = friendsData.length;
      statsBox.innerHTML += '<br>Друзей: ' + countFriends;
    }

    function handleSaveStatus() {
      if (!currentUser) return;
      const status = (statusInput.value || '').trim() || 'Статус не задан.';
      const statuses = loadStatuses();
      statuses[currentUser] = status;
      saveStatuses(statuses);

      profileStatus.textContent = status;
      accountBox.innerHTML =
        'Логин: <b>' + currentUser + '</b><br>' +
        'Роль: ' + (isAdminUser(currentUser) ? 'admin' : 'user') + '<br>' +
        'Статус: ' + status;

      settingsHint.textContent = 'Статус сохранён.';
    }

    async function handleSaveAvatar() {
      if (!currentUser) return;
      const url = (avatarInput.value || '').trim();
      const avatars = loadAvatars();
      avatars[currentUser] = url;
      saveAvatars(avatars);

      const avatarHtmlProfile = url
        ? '<img src="' + url + '" alt="">'
        : firstLetter(currentUser);
      profileAvatar.innerHTML = avatarHtmlProfile;

      const avatarHtmlTop = url
        ? '<div class="avatar-small"><img src="' + url + '" alt=""></div>'
        : '<div class="avatar-small">' + firstLetter(currentUser) + '</div>';

      topbarUser.innerHTML =
        avatarHtmlTop +
        '<span>' + currentUser + (isAdminUser(currentUser) ? ' (admin)' : '') + '</span>';

      settingsHint.textContent = 'Аватар сохранён.';
    }

    function showSection(name) {
      sectionNews.style.display     = 'none';
      sectionMessages.style.display = 'none';
      sectionProfile.style.display  = 'none';
      sectionSettings.style.display = 'none';

      if (name === 'news')      sectionNews.style.display = 'block';
      if (name === 'messages')  sectionMessages.style.display = 'block';
      if (name === 'profile')   sectionProfile.style.display = 'block';
      if (name === 'settings')  sectionSettings.style.display = 'block';

      document.querySelectorAll('.left-menu a[data-nav]').forEach(a => {
        if (a.getAttribute('data-nav') === name) a.classList.add('active');
        else a.classList.remove('active');
      });
    }

    async function adminMute() {
      const user = (adminTargetUser.value || '').trim();
      if (!user) {
        adminHint.textContent = 'Укажите логин пользователя.';
        return;
      }
      adminHint.textContent = 'Выдаём mute...';
      try {
        const resp = await fetch(API_BASE + '/api/admin/mute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ admin: currentUser, user, minutes: 30 })
        });
        const data = await resp.json();
        if (!resp.ok) {
          adminHint.textContent = data.error || 'Ошибка mute.';
          return;
        }
        adminHint.textContent = 'Выдан mute на 30 минут пользователю ' + user;
      } catch {
        adminHint.textContent = 'Сервер недоступен.';
      }
    }

    async function adminUnmute() {
      const user = (adminTargetUser.value || '').trim();
      if (!user) {
        adminHint.textContent = 'Укажите логин пользователя.';
        return;
      }
      adminHint.textContent = 'Снимаем mute...';
      try {
        const resp = await fetch(API_BASE + '/api/admin/unmute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ admin: currentUser, user })
        });
        const data = await resp.json();
        if (!resp.ok) {
          adminHint.textContent = data.error || 'Ошибка unmute.';
          return;
        }
        adminHint.textContent = 'Mute снят с ' + user;
      } catch {
        adminHint.textContent = 'Сервер недоступен.';
      }
    }

    async function adminCleanupUsers() {
      if (!confirm('Удалить все пустые аккаунты (без постов и друзей)?')) return;
      adminHint.textContent = 'Чистим пользователей...';
      try {
        const resp = await fetch(API_BASE + '/api/admin/cleanup-users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ admin: currentUser })
        });
        const data = await resp.json();
        if (!resp.ok) {
          adminHint.textContent = data.error || 'Ошибка очистки.';
          return;
        }
        adminHint.textContent = 'Удалено аккаунтов: ' + (data.removed ? data.removed.length : 0);
      } catch {
        adminHint.textContent = 'Сервер недоступен.';
      }
    }

    document.querySelectorAll('.left-menu a[data-nav]').forEach(a => {
      a.addEventListener('click', () => {
        const target = a.getAttribute('data-nav');
        if (!currentUser) return;
        if (target === 'profile') {
          showSection('profile');
          fetchFriends();
        }
        if (target === 'news') {
          showSection('news');
          fetchFeed();
        }
        if (target === 'messages') {
          showSection('messages');
          fetchDialogs();
        }
        if (target === 'settings') showSection('settings');
        closeMenu();
      });
    });

    registerBtn.addEventListener('click', handleRegister);
    loginBtn.addEventListener('click', handleLogin);
    logoutLink.addEventListener('click', handleLogout);

    saveStatusBtn.addEventListener('click', handleSaveStatus);
    saveAvatarBtn.addEventListener('click', handleSaveAvatar);
    addPostBtn.addEventListener('click', handleAddPost);

    addFriendBtn.addEventListener('click', handleAddFriend);
    addFriendInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        handleAddFriend();
      }
    });

    postInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        handleAddPost();
      }
    });

    chatSendBtn.addEventListener('click', handleSendMessage);
    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        handleSendMessage();
      }
    });

    inlineFeedSearchInput.addEventListener('input', () => {
      feedSearchInput.value = inlineFeedSearchInput.value;
      renderFeed();
    });
    feedSearchInput.addEventListener('input', applyFeedFilter);
    feedSearchClearBtn.addEventListener('click', () => {
      feedSearchInput.value = '';
      inlineFeedSearchInput.value = '';
      applyFeedFilter();
    });
    feedFilterSelect.addEventListener('change', applyFeedFilter);

    adminMuteBtn.addEventListener('click', adminMute);
    adminUnmuteBtn.addEventListener('click', adminUnmute);
    adminCleanupBtn.addEventListener('click', adminCleanupUsers);

    burgerBtn.addEventListener('click', () => {
      if (leftMenu.classList.contains('menu-open')) closeMenu();
      else openMenu();
    });
    menuOverlay.addEventListener('click', closeMenu);

    (async function init() {
      const savedUser = localStorage.getItem(STORAGE_KEY_CURRENT);
      if (savedUser) {
        currentUser = savedUser;
      }
      renderAuthState();
      if (currentUser) {
        await fetchAndRenderPosts();
        await fetchFeed();
        await fetchDialogs();
        await fetchFriends();
        showSection('news');
      }
    })();
  </script>
</body>
</html>
