<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>@type5 (25.12.2025/20:10) </title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #f0f4ff 0, #e9edf1 40%, #dde3ea 100%);
    }
    a { color: #2a5885; text-decoration: none; }

    .topbar {
      height: 52px;
      background: linear-gradient(90deg,#4a76a8,#355d88);
      color: #fff;
      display: flex;
      align-items: center;
      padding: 0 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.18);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .topbar-logo {
      font-weight: 800;
      font-size: 20px;
      margin-right: 18px;
      letter-spacing: 0.02em;
    }
    .topbar-logo span {
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(0,0,0,0.12);
    }
    .topbar-search {
      flex: 1;
      max-width: 360px;
    }
    .topbar-search input {
      width: 100%;
      padding: 6px 10px;
      border-radius: 14px;
      border: none;
      font-size: 13px;
      outline: none;
      background: rgba(255,255,255,0.15);
      color: #fff;
    }
    .topbar-search input::placeholder {
      color: rgba(255,255,255,0.7);
    }
    .topbar-right {
      margin-left: auto;
      font-size: 13px;
      opacity: 0.9;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .avatar-small {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #f5f7fa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #355d88;
      font-weight: 700;
      overflow: hidden;
    }
    .avatar-small img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .layout {
      max-width: 980px;
      margin: 16px auto 32px;
      display: grid;
      grid-template-columns: 210px minmax(0, 1fr) 230px;
      gap: 14px;
      padding: 0 10px;
    }

    .left-menu {
      font-size: 13px;
    }
    .left-menu-section {
      margin-bottom: 10px;
      background: rgba(255,255,255,0.85);
      border-radius: 8px;
      padding: 6px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid #d3dde7;
    }
    .left-menu a {
      display: block;
      padding: 4px 12px;
      color: #2a5885;
      border-radius: 4px;
      cursor: pointer;
    }
    .left-menu a:hover {
      background: #dfe6f1;
    }
    .left-menu .section-title {
      padding: 4px 12px 2px;
      color: #777;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.04em;
    }

    .content { font-size: 13px; }
    .right-column { font-size: 12px; }

    .card {
      background: rgba(255,255,255,0.95);
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      border: 1px solid #d3dde7;
      margin-bottom: 10px;
      overflow: hidden;
    }
    .card-header {
      padding: 8px 10px;
      border-bottom: 1px solid #e5ebf1;
      font-weight: 600;
      font-size: 13px;
      background: #f5f7fa;
    }
    .card-body {
      padding: 10px;
    }

    label {
      display: block;
      margin-bottom: 4px;
      color: #555;
    }

    input[type="text"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: 7px 8px;
      border-radius: 6px;
      border: 1px solid #c5d0db;
      font-size: 13px;
      font-family: inherit;
      background: #fbfcfe;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 180px;
    }

    button {
      border: none;
      border-radius: 16px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.15s, transform 0.05s;
    }
    button:active { transform: translateY(1px); }
    .btn-primary {
      background: #4a76a8;
      color: #fff;
    }
    .btn-primary:hover { background: #3b6088; }
    .btn-secondary {
      background: #e5ebf1;
      color: #2a5885;
    }
    .btn-secondary:hover { background: #d6deea; }
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .posts {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 430px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .post {
      border-radius: 8px;
      padding: 8px 9px;
      background: #f5f7fa;
      border: 1px solid #e5ebf1;
      display: flex;
      gap: 8px;
    }
    .post-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #dfe6f1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #2a5885;
      font-weight: 700;
      flex-shrink: 0;
      overflow: hidden;
    }
    .post-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .post-main { flex: 1; }
    .post-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 12px;
      color: #777;
      align-items: center;
    }
    .post-author {
      font-weight: 600;
      color: #2a5885;
    }
    .post-time {
      white-space: nowrap;
      font-size: 11px;
    }
    .post-text {
      margin-top: 4px;
      font-size: 13px;
      color: #000;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .post-footer {
      margin-top: 4px;
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 11px;
      color: #777;
    }
    .like-btn {
      cursor: pointer;
      color: #2a5885;
    }

    .empty {
      font-size: 12px;
      color: #777;
      text-align: center;
      padding: 12px 0;
    }
    .small {
      font-size: 11px;
      color: #888;
      margin-top: 4px;
    }

    .page { display: none; }
    .page-active { display: block; }

    #page-auth {
      max-width: 360px;
      margin: 50px auto;
    }

    @media (max-width: 880px) {
      .layout {
        grid-template-columns: 190px minmax(0, 1fr);
      }
      .right-column {
        display: none;
      }
    }

    @media (max-width: 680px) {
      .layout { display: block; }
      .left-menu { display: none; }
      #page-auth { margin-top: 24px; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-logo"><span>@type</span></div>
    <div class="topbar-search">
      <input type="text" placeholder="Поиск (по ленте внизу)">
    </div>
    <div class="topbar-right" id="topbarUser">
      <div class="avatar-small">?</div>
      <span>Не авторизован</span>
    </div>
  </div>

  <div id="page-auth" class="page page-active">
    <div class="card">
      <div class="card-header">Вход в @type</div>
      <div class="card-body">
        <label for="loginName">Логин</label>
        <input type="text" id="loginName" placeholder="логин">

        <label for="loginPass" style="margin-top:6px;">Пароль</label>
        <input type="password" id="loginPass" placeholder="пароль">

        <div class="btn-group">
          <button class="btn-primary" id="loginBtn">Войти</button>
          <button class="btn-secondary" id="registerBtn">Зарегистрироваться</button>
        </div>
        <div class="small" id="authHint">
          Аккаунты, посты, друзья и сообщения хранятся на сервере @type‑backend.
        </div>
      </div>
    </div>
  </div>

  <div id="page-app" class="page">
    <div class="layout">
      <nav class="left-menu">
        <div class="left-menu-section">
          <div class="section-title">Разделы</div>
          <a data-nav="profile">Моя страница</a>
          <a data-nav="news">Моя лента</a>
          <a data-nav="messages">Сообщения</a>
        </div>
        <div class="left-menu-section">
          <div class="section-title">@type</div>
          <a data-nav="settings">Настройки</a>
          <a id="logoutLink">Выход</a>
        </div>
      </nav>

      <main class="content">
        <!-- Профиль -->
        <div id="section-profile" class="page page-active">
          <div class="card">
            <div class="card-header">Моя страница</div>
            <div class="card-body">
              <div style="display:flex;gap:10px;align-items:center;margin-bottom:6px;">
                <div class="avatar-small" id="profileAvatar">?</div>
                <div id="profileInfo"></div>
              </div>

              <label for="statusInput" style="margin-top:6px;">Статус</label>
              <input type="text" id="statusInput" placeholder="Напишите статус...">
              <div class="btn-group">
                <button class="btn-primary" id="saveStatusBtn">Сохранить статус</button>
              </div>

              <label for="avatarInput" style="margin-top:6px;">Аватар (URL картинки)</label>
              <input type="text" id="avatarInput" placeholder="https://...">
              <div class="btn-group">
                <button class="btn-secondary" id="saveAvatarBtn">Сохранить аватар</button>
              </div>

              <hr style="margin:10px 0;border:none;border-top:1px solid #e5ebf1;">

              <label style="margin-bottom:4px;">Мои друзья</label>
              <div class="small" id="friendsList">
                Загрузка списка друзей...
              </div>

              <div class="btn-group" style="margin-top:8px;">
                <input type="text" id="addFriendInput" placeholder="Логин друга" style="flex:1;min-width:0;">
                <button class="btn-secondary" id="addFriendBtn">Добавить друга</button>
              </div>

              <div class="small" id="friendsHint" style="margin-top:4px;"></div>

              <div class="small" style="margin-top:6px;">
                Статус и аватар кэшируются в этом браузере, а друзья и чаты — на сервере.
              </div>
            </div>
          </div>
        </div>

        <!-- Лента -->
        <div id="section-news" class="page">
          <div class="card">
            <div class="card-header">Новый пост</div>
            <div class="card-body">
              <label for="postInput">Что у вас нового?</label>
              <textarea id="postInput" placeholder="Напишите что‑нибудь..."></textarea>
              <div class="btn-group">
                <button class="btn-primary" id="addPostBtn">Опубликовать</button>
              </div>
              <div class="small" id="postHint"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">Моя лента</div>
            <div class="card-body">
              <div style="display:flex;gap:6px;margin-bottom:6px;flex-wrap:wrap;">
                <select id="feedFilterSelect" style="padding:6px 8px;border-radius:6px;border:1px solid #c5d0db;">
                  <option value="all">Все посты</option>
                  <option value="friends">Только друзей</option>
                </select>
                <input type="text" id="feedSearchInput" placeholder="Поиск по авторам и тексту..." style="flex:1;min-width:140px;">
                <button class="btn-secondary" id="feedSearchClearBtn">Сброс</button>
              </div>
              <div id="postsContainer" class="posts"></div>
            </div>
          </div>
        </div>

        <!-- Сообщения -->
        <div id="section-messages" class="page">
          <div class="card">
            <div class="card-header">Сообщения</div>
            <div class="card-body" style="display:flex;gap:10px;min-height:220px;">
              <div style="width:35%;max-width:180px;border-right:1px solid #e5ebf1;padding-right:6px;">
                <div class="small" style="margin-bottom:4px;">Диалоги</div>
                <div id="dialogsList" class="small">
                  Загрузка...
                </div>
              </div>
              <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
                <div id="chatTitle" class="small">Выберите собеседника слева или друга в профиле.</div>
                <div id="chatMessages" style="flex:1;border:1px solid #e5ebf1;border-radius:6px;padding:6px;overflow-y:auto;background:#f5f7fa;"></div>
                <div style="display:flex;gap:6px;">
                  <input type="text" id="chatInput" placeholder="Написать сообщение..." style="flex:1;">
                  <button class="btn-primary" id="chatSendBtn">Отправить</button>
                </div>
                <div class="small" id="chatHint"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Настройки -->
        <div id="section-settings" class="page">
          <div class="card">
            <div class="card-header">Настройки аккаунта</div>
            <div class="card-body">
              <div class="small">
                В этой версии можно менять статус, ставить аватар по URL, добавлять друзей и переписываться.  
                Плюс есть скрытая админ‑панель для модерации.
              </div>

              <hr style="margin:10px 0;border:none;border-top:1px solid #e5ebf1;">

              <div id="adminPanel" style="display:none;">
                <div class="small" style="margin-bottom:6px;">
                  Админ‑панель (видна только тестовому администратору).
                </div>

                <label for="adminTargetUser">Пользователь для действий</label>
                <input type="text" id="adminTargetUser" placeholder="логин пользователя">

                <div class="btn-group">
                  <button class="btn-secondary" id="adminMuteBtn">Mute 30 мин</button>
                  <button class="btn-secondary" id="adminUnmuteBtn">Снять mute</button>
                </div>

                <div class="btn-group">
                  <button class="btn-secondary" id="adminCleanupBtn">Удалить пустые аккаунты</button>
                </div>

                <div class="small" id="adminHint"></div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <aside class="right-column">
        <div class="card">
          <div class="card-header">Инфо</div>
          <div class="card-body" id="infoBox">
            Не авторизован.
          </div>
        </div>

        <div class="card">
          <div class="card-header">Статистика</div>
          <div class="card-body" id="statsBox">
            Постов: 0<br>
            Лайков: 0
          </div>
        </div>
      </aside>
    </div>
  </div>
  <script>
    const API_BASE = 'https://atype-backend.onrender.com';

    const STORAGE_KEY_CURRENT  = 'atype_current_user_net';
    const STORAGE_KEY_STATUSES = 'atype_statuses';
    const STORAGE_KEY_AVATARS  = 'atype_avatars';

    const pageAuth = document.getElementById('page-auth');
    const pageApp  = document.getElementById('page-app');

    const loginName = document.getElementById('loginName');
    const loginPass = document.getElementById('loginPass');
    const loginBtn  = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const authHint  = document.getElementById('authHint');

    const topbarUser = document.getElementById('topbarUser');
    const infoBox    = document.getElementById('infoBox');
    const logoutLink = document.getElementById('logoutLink');

    const profileInfo   = document.getElementById('profileInfo');
    const profileAvatar = document.getElementById('profileAvatar');
    const statusInput   = document.getElementById('statusInput');
    const saveStatusBtn = document.getElementById('saveStatusBtn');
    const avatarInput   = document.getElementById('avatarInput');
    const saveAvatarBtn = document.getElementById('saveAvatarBtn');

    const friendsList    = document.getElementById('friendsList');
    const addFriendInput = document.getElementById('addFriendInput');
    const addFriendBtn   = document.getElementById('addFriendBtn');
    const friendsHint    = document.getElementById('friendsHint');

    const postInput       = document.getElementById('postInput');
    const addPostBtn      = document.getElementById('addPostBtn');
    const postsContainer  = document.getElementById('postsContainer');
    const postHint        = document.getElementById('postHint');
    const statsBox        = document.getElementById('statsBox');

    const dialogsList   = document.getElementById('dialogsList');
    const chatTitle     = document.getElementById('chatTitle');
    const chatMessages  = document.getElementById('chatMessages');
    const chatInput     = document.getElementById('chatInput');
    const chatSendBtn   = document.getElementById('chatSendBtn');
    const chatHint      = document.getElementById('chatHint');

    const feedSearchInput    = document.getElementById('feedSearchInput');
    const feedSearchClearBtn = document.getElementById('feedSearchClearBtn');
    const feedFilterSelect   = document.getElementById('feedFilterSelect');

    const adminPanel      = document.getElementById('adminPanel');
    const adminTargetUser = document.getElementById('adminTargetUser');
    const adminMuteBtn    = document.getElementById('adminMuteBtn');
    const adminUnmuteBtn  = document.getElementById('adminUnmuteBtn');
    const adminCleanupBtn = document.getElementById('adminCleanupBtn');
    const adminHint       = document.getElementById('adminHint');

    const sections = {
      profile: document.getElementById('section-profile'),
      news: document.getElementById('section-news'),
      messages: document.getElementById('section-messages'),
      settings: document.getElementById('section-settings')
    };

    let currentUser = null;
    let currentUserAvatar = '';
    let currentPosts = [];
    let totalLikes = 0;
    let currentDialogWith = null;
    let allFeedPosts = [];
    let friendsCache = [];

    function getInitials(login) {
      if (!login) return '?';
      return login.trim().charAt(0).toUpperCase();
    }

    function loadStatuses() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_STATUSES);
        if (!raw) return {};
        const obj = JSON.parse(raw);
        return obj && typeof obj === 'object' ? obj : {};
      } catch {
        return {};
      }
    }

    function saveStatuses(statuses) {
      localStorage.setItem(STORAGE_KEY_STATUSES, JSON.stringify(statuses));
    }

    function loadAvatars() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_AVATARS);
        if (!raw) return {};
        const obj = JSON.parse(raw);
        return obj && typeof obj === 'object' ? obj : {};
      } catch {
        return {};
      }
    }

    function saveAvatars(map) {
      localStorage.setItem(STORAGE_KEY_AVATARS, JSON.stringify(map));
    }

    function renderAuthState() {
      if (currentUser) {
        pageAuth.classList.remove('page-active');
        pageApp.classList.add('page-active');

        const avatars = loadAvatars();
        currentUserAvatar = avatars[currentUser] || '';

        topbarUser.innerHTML = '';
        const wrap = document.createElement('div');
        wrap.style.display = 'flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '8px';

        const av = document.createElement('div');
        av.className = 'avatar-small';

        if (currentUserAvatar) {
          const img = document.createElement('img');
          img.src = currentUserAvatar;
          img.alt = 'avatar';
          img.onerror = () => {
            img.style.display = 'none';
            av.textContent = getInitials(currentUser);
          };
          av.appendChild(img);
        } else {
          av.textContent = getInitials(currentUser);
        }

        const span = document.createElement('span');
        span.textContent = currentUser;

        wrap.appendChild(av);
        wrap.appendChild(span);
        topbarUser.appendChild(wrap);

        infoBox.textContent = 'Вы вошли как ' + currentUser;

        // показать админ-панель только тестовому админу
        if (adminPanel) {
          if (currentUser === 'testa acc') {
            adminPanel.style.display = 'block';
          } else {
            adminPanel.style.display = 'none';
          }
        }

        renderProfile();
      } else {
        pageAuth.classList.add('page-active');
        pageApp.classList.remove('page-active');
        topbarUser.innerHTML = '<div class="avatar-small">?</div><span>Не авторизован</span>';
        infoBox.textContent = 'Не авторизован.';
        if (adminPanel) adminPanel.style.display = 'none';
      }
    }

    function renderProfile() {
      if (!currentUser) return;
      const statuses = loadStatuses();
      const status = statuses[currentUser] || 'нет статуса';

      const avatars = loadAvatars();
      currentUserAvatar = avatars[currentUser] || '';

      profileAvatar.innerHTML = '';
      if (currentUserAvatar) {
        const img = document.createElement('img');
        img.src = currentUserAvatar;
        img.alt = 'avatar';
        img.onerror = () => {
          img.style.display = 'none';
          profileAvatar.textContent = getInitials(currentUser);
        };
        profileAvatar.appendChild(img);
      } else {
        profileAvatar.textContent = getInitials(currentUser);
      }

      profileInfo.innerHTML =
        '<b>Логин:</b> ' + currentUser + '<br>' +
        '<b>Статус:</b> ' + status;

      statusInput.value = statuses[currentUser] || '';
      avatarInput.value = currentUserAvatar || '';
    }

    function renderPostsFromArray(arr) {
      currentPosts = arr || [];
      postsContainer.innerHTML = '';
      if (!currentUser) return;

      if (!arr || arr.length === 0) {
        const div = document.createElement('div');
        div.className = 'empty';
        div.textContent = 'В ленте пока нет постов.';
        postsContainer.appendChild(div);
        statsBox.innerHTML = 'Постов: 0<br>Лайков: ' + totalLikes;
        return;
      }

      const sorted = [...arr].sort((a, b) => new Date(b.time) - new Date(a.time));

      for (const p of sorted) {
        const postEl = document.createElement('div');
        postEl.className = 'post';
        const postId = p.id;

        const avatar = document.createElement('div');
        avatar.className = 'post-avatar';

        const avatars = loadAvatars();
        const url = avatars[p.author] || '';
        if (url) {
          const img = document.createElement('img');
          img.src = url;
          img.alt = 'avatar';
          img.onerror = () => {
            img.style.display = 'none';
            avatar.textContent = getInitials(p.author);
          };
          avatar.appendChild(img);
        } else {
          avatar.textContent = getInitials(p.author);
        }

        const main = document.createElement('div');
        main.className = 'post-main';

        const header = document.createElement('div');
        header.className = 'post-header';

        const author = document.createElement('span');
        author.className = 'post-author';
        author.textContent = p.author;

        const timeSpan = document.createElement('span');
        timeSpan.className = 'post-time';
        const dt = new Date(p.time || Date.now());
        timeSpan.textContent = dt.toLocaleString();

        header.appendChild(author);
        header.appendChild(timeSpan);

        const text = document.createElement('div');
        text.className = 'post-text';
        text.textContent = p.text;

        const footer = document.createElement('div');
        footer.className = 'post-footer';

        const likeSpan = document.createElement('span');
        likeSpan.className = 'like-btn';
        likeSpan.textContent = '♡ 0';
        let likeCount = 0;
        likeSpan.addEventListener('click', () => {
          likeCount++;
          totalLikes++;
          likeSpan.textContent = '♥ ' + likeCount;
          statsBox.innerHTML = 'Постов: ' + sorted.length + '<br>Лайков: ' + totalLikes;
        });
        footer.appendChild(likeSpan);

        // кнопка удаления: свои посты или админ
        if (p.author === currentUser || currentUser === 'testa acc') {
          const delBtn = document.createElement('span');
          delBtn.style.cursor = 'pointer';
          delBtn.style.color = '#c0392b';
          delBtn.textContent = 'удалить';
          delBtn.addEventListener('click', async () => {
            if (!confirm('Удалить пост?')) return;
            try {
              const resp = await fetch(
                API_BASE + '/api/posts/' + encodeURIComponent(postId) +
                '?author=' + encodeURIComponent(currentUser),
                { method: 'DELETE' }
              );
              const data = await resp.json();
              if (!resp.ok) {
                alert(data.error || 'Не удалось удалить пост');
                return;
              }
              await fetchFeed();
            } catch {
              alert('Сервер недоступен.');
            }
          });
          footer.appendChild(delBtn);
        }

        main.appendChild(header);
        main.appendChild(text);
        main.appendChild(footer);

        postEl.appendChild(avatar);
        postEl.appendChild(main);

        postsContainer.appendChild(postEl);
      }

      statsBox.innerHTML = 'Постов: ' + sorted.length + '<br>Лайков: ' + totalLikes;
    }

    function showSection(name) {
      Object.entries(sections).forEach(([key, el]) => {
        if (key === name) el.classList.add('page-active');
        else el.classList.remove('page-active');
      });
    }

    async function handleRegister() {
      const login = (loginName.value || '').trim();
      const pass = (loginPass.value || '').trim();
      if (!login || !pass) {
        authHint.textContent = 'Введите логин и пароль для регистрации.';
        return;
      }
      try {
        const resp = await fetch(API_BASE + '/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ login, password: pass })
        });
        const data = await resp.json();
        if (!resp.ok) {
          authHint.textContent = data.error || 'Ошибка регистрации.';
          return;
        }
        authHint.textContent = 'Аккаунт создан, теперь можно войти.';
      } catch {
        authHint.textContent = 'Сервер недоступен.';
      }
    }

    async function handleLogin() {
      const login = (loginName.value || '').trim();
      const pass = (loginPass.value || '').trim();
      if (!login || !pass) {
        authHint.textContent = 'Введите логин и пароль.';
        return;
      }
      try {
        const resp = await fetch(API_BASE + '/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ login, password: pass })
        });
        const data = await resp.json();
        if (!resp.ok) {
          authHint.textContent = data.error || 'Ошибка входа.';
          return;
        }
        currentUser = data.login;
        localStorage.setItem(STORAGE_KEY_CURRENT, currentUser);
        authHint.textContent = '';
        renderAuthState();
        showSection('news');
        await fetchAndRenderPosts();
        await fetchFeed();
        await fetchDialogs();
        await fetchFriends();
      } catch {
        authHint.textContent = 'Сервер недоступен.';
      }
    }

    function handleLogout() {
      currentUser = null;
      localStorage.removeItem(STORAGE_KEY_CURRENT);
      renderAuthState();
    }

    function handleSaveStatus() {
      if (!currentUser) return;
      const statuses = loadStatuses();
      statuses[currentUser] = statusInput.value || '';
      saveStatuses(statuses);
      renderProfile();
    }

    async function handleSaveAvatar() {
      if (!currentUser) return;
      const url = (avatarInput.value || '').trim();
      const avatars = loadAvatars();
      avatars[currentUser] = url;
      saveAvatars(avatars);
      currentUserAvatar = url;
      renderProfile();

      try {
        await fetch(API_BASE + '/api/avatar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ login: currentUser, avatar: url })
        });
      } catch {}
    }

    async function fetchAndRenderPosts() {
      if (!currentUser) return;
      postHint.textContent = 'Загружаем ваши посты...';
      try {
        const resp = await fetch(API_BASE + '/api/posts?author=' + encodeURIComponent(currentUser));
        await resp.json();
        postHint.textContent = '';
      } catch {
        postHint.textContent = 'Не удалось загрузить посты.';
      }
    }

    async function fetchFeed() {
      if (!currentUser) return;
      postHint.textContent = 'Загружаем ленту...';
      try {
        const resp = await fetch(API_BASE + '/api/feed');
        const data = await resp.json();
        if (!Array.isArray(data)) {
          postHint.textContent = 'Ошибка формата ленты.';
          return;
        }
        allFeedPosts = data;
        postHint.textContent = '';
        applyFeedFilter();
      } catch {
        postHint.textContent = 'Не удалось загрузить ленту.';
      }
    }

    function applyFeedFilter() {
      const q = (feedSearchInput.value || '').trim().toLowerCase();
      const mode = feedFilterSelect.value;
      let list = allFeedPosts;

      if (mode === 'friends') {
        list = list.filter(p => friendsCache.includes(p.author));
      }

      if (q) {
        list = list.filter(p => {
          const t = (p.text || '').toLowerCase();
          const a = (p.author || '').toLowerCase();
          return t.includes(q) || a.includes(q);
        });
      }

      renderPostsFromArray(list);
    }

    async function handleAddPost() {
      if (!currentUser) return;
      const text = (postInput.value || '').trim();
      if (!text) {
        alert('Нельзя опубликовать пустой пост.');
        return;
      }
      try {
        const resp = await fetch(API_BASE + '/api/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ author: currentUser, text })
        });
        const data = await resp.json();
        if (!resp.ok) {
          alert(data.error || 'Ошибка при создании поста.');
          return;
        }
        postInput.value = '';
        await fetchFeed();
      } catch {
        alert('Сервер недоступен.');
      }
    }

    async function fetchFriends() {
      if (!currentUser) return;
      friendsList.textContent = 'Загрузка списка друзей...';
      friendsHint.textContent = '';
      try {
        const resp = await fetch(API_BASE + '/api/friends?user=' + encodeURIComponent(currentUser));
        const data = await resp.json();
        if (!resp.ok) {
          friendsList.textContent = data.error || 'Ошибка загрузки друзей.';
          return;
        }
        renderFriends(data);
      } catch {
        friendsList.textContent = 'Сервер недоступен.';
      }
    }

    function renderFriends(list) {
      friendsCache = Array.isArray(list) ? list.slice() : [];
      friendsList.innerHTML = '';
      if (!list || list.length === 0) {
        friendsList.textContent = 'У вас пока нет друзей.';
        applyFeedFilter();
        return;
      }
      const ul = document.createElement('div');
      list.forEach(name => {
        const row = document.createElement('div');
        row.textContent = name;
        row.style.cursor = 'pointer';
        row.style.padding = '2px 0';
        row.style.borderRadius = '4px';
        row.addEventListener('click', () => {
          currentDialogWith = name;
          showSection('messages');
          openChatWith(name);
          fetchDialogs();
        });
        ul.appendChild(row);
      });
      friendsList.appendChild(ul);
      applyFeedFilter();
    }

    async function handleAddFriend() {
      if (!currentUser) return;
      const friend = (addFriendInput.value || '').trim();
      if (!friend) {
        friendsHint.textContent = 'Введите логин друга.';
        return;
      }
      if (friend === currentUser) {
        friendsHint.textContent = 'Нельзя добавить себя.';
        return;
      }
      friendsHint.textContent = 'Отправка...';
      try {
        const resp = await fetch(API_BASE + '/api/friends/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: currentUser, friend })
        });
        const data = await resp.json();
        if (!resp.ok) {
          friendsHint.textContent = data.error || 'Ошибка добавления друга.';
          return;
        }
        friendsHint.textContent = 'Друг добавлен.';
        addFriendInput.value = '';
        await fetchFriends();
      } catch {
        friendsHint.textContent = 'Сервер недоступен.';
      }
    }

    async function fetchDialogs() {
      if (!currentUser) return;
      dialogsList.textContent = 'Загрузка...';
      try {
        const resp = await fetch(API_BASE + '/api/dialogs?user=' + encodeURIComponent(currentUser));
        const data = await resp.json();
        renderDialogs(data);
      } catch {
        dialogsList.textContent = 'Не удалось загрузить диалоги.';
      }
    }

    function renderDialogs(list) {
      dialogsList.innerHTML = '';
      if (!list || list.length === 0) {
        dialogsList.textContent = 'Пока нет диалогов.';
        return;
      }
      list.forEach(login => {
        const item = document.createElement('div');
        item.textContent = login;
        item.style.cursor = 'pointer';
        item.style.padding = '3px 4px';
        item.style.borderRadius = '4px';
        item.addEventListener('click', () => {
          currentDialogWith = login;
          Array.from(dialogsList.children).forEach(c => c.style.background = '');
          item.style.background = '#dfe6f1';
          openChatWith(login);
        });
        dialogsList.appendChild(item);
      });
    }

    async function updateOnlineStatus(login) {
      try {
        const resp = await fetch(API_BASE + '/api/online?login=' + encodeURIComponent(login));
        const data = await resp.json();
        if (!resp.ok) return;
        const status = data.online ? ' (в сети)' : ' (не в сети)';
        chatTitle.textContent = 'Диалог с ' + login + status;
      } catch {}
    }

    async function openChatWith(withUser) {
      if (!currentUser || !withUser) return;
      chatTitle.textContent = 'Диалог с ' + withUser;
      chatMessages.innerHTML = 'Загрузка...';
      chatHint.textContent = '';
      updateOnlineStatus(withUser);
      try {
        const resp = await fetch(
          API_BASE + '/api/messages?user=' + encodeURIComponent(currentUser) +
          '&with=' + encodeURIComponent(withUser)
        );
        const data = await resp.json();
        renderChatMessages(data);
      } catch {
        chatMessages.textContent = 'Не удалось загрузить сообщения.';
      }
    }

    function renderChatMessages(msgs) {
      chatMessages.innerHTML = '';
      if (!msgs || msgs.length === 0) {
        chatMessages.innerHTML = '<div class="small">Пока нет сообщений.</div>';
        return;
      }
      msgs.forEach(m => {
        const row = document.createElement('div');
        row.style.marginBottom = '4px';
        row.style.textAlign = m.from === currentUser ? 'right' : 'left';

        const bubble = document.createElement('span');
        bubble.textContent = m.text;
        bubble.style.display = 'inline-block';
        bubble.style.padding = '4px 6px';
        bubble.style.borderRadius = '8px';
        bubble.style.maxWidth = '80%';
        bubble.style.wordWrap = 'break-word';
        bubble.style.fontSize = '12px';
        bubble.style.background = (m.from === currentUser) ? '#cfe4ff' : '#ffffff';

        row.appendChild(bubble);
        chatMessages.appendChild(row);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function handleSendMessage() {
      if (!currentUser) return;
      if (!currentDialogWith) {
        chatHint.textContent = 'Сначала выберите собеседника или друга.';
        return;
      }
      const text = (chatInput.value || '').trim();
      if (!text) return;
      chatHint.textContent = 'Отправка...';
      try {
        const resp = await fetch(API_BASE + '/api/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ from: currentUser, to: currentDialogWith, text })
        });
        const data = await resp.json();
        if (!resp.ok) {
          chatHint.textContent = data.error || 'Ошибка отправки.';
          return;
        }
        chatInput.value = '';
        chatHint.textContent = '';
        await openChatWith(currentDialogWith);
        await fetchDialogs();
      } catch {
        chatHint.textContent = 'Сервер недоступен.';
      }
    }

    async function adminMute() {
      const user = (adminTargetUser.value || '').trim();
      if (!user) {
        adminHint.textContent = 'Укажите логин пользователя.';
        return;
      }
      adminHint.textContent = 'Отправка mute...';
      try {
        const resp = await fetch(API_BASE + '/api/admin/mute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ admin: currentUser, user, minutes: 30 })
        });
        const data = await resp.json();
        if (!resp.ok) {
          adminHint.textContent = data.error || 'Ошибка mute.';
          return;
        }
        adminHint.textContent = 'Пользователь ' + user + ' в mute до ' + data.mutedUntil;
      } catch {
        adminHint.textContent = 'Сервер недоступен.';
      }
    }

    async function adminUnmute() {
      const user = (adminTargetUser.value || '').trim();
      if (!user) {
        adminHint.textContent = 'Укажите логин пользователя.';
        return;
      }
      adminHint.textContent = 'Снимаем mute...';
      try {
        const resp = await fetch(API_BASE + '/api/admin/unmute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ admin: currentUser, user })
        });
        const data = await resp.json();
        if (!resp.ok) {
          adminHint.textContent = data.error || 'Ошибка unmute.';
          return;
        }
        adminHint.textContent = 'Mute снят с ' + user;
      } catch {
        adminHint.textContent = 'Сервер недоступен.';
      }
    }

    async function adminCleanupUsers() {
      if (!confirm('Удалить все пустые аккаунты (без постов и друзей)?')) return;
      adminHint.textContent = 'Чистим пользователей...';
      try {
        const resp = await fetch(API_BASE + '/api/admin/cleanup-users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ admin: currentUser })
        });
        const data = await resp.json();
        if (!resp.ok) {
          adminHint.textContent = data.error || 'Ошибка очистки.';
          return;
        }
        adminHint.textContent = 'Удалено аккаунтов: ' + data.removed.length;
      } catch {
        adminHint.textContent = 'Сервер недоступен.';
      }
    }

    document.querySelectorAll('.left-menu a[data-nav]').forEach(a => {
      a.addEventListener('click', () => {
        const target = a.getAttribute('data-nav');
        if (!currentUser) return;
        if (target === 'profile') {
          showSection('profile');
          fetchFriends();
        }
        if (target === 'news') {
          showSection('news');
          fetchFeed();
        }
        if (target === 'messages') {
          showSection('messages');
          fetchDialogs();
        }
        if (target === 'settings') showSection('settings');
      });
    });

    registerBtn.addEventListener('click', handleRegister);
    loginBtn.addEventListener('click', handleLogin);
    logoutLink.addEventListener('click', handleLogout);

    saveStatusBtn.addEventListener('click', handleSaveStatus);
    saveAvatarBtn.addEventListener('click', handleSaveAvatar);
    addPostBtn.addEventListener('click', handleAddPost);

    addFriendBtn.addEventListener('click', handleAddFriend);
    addFriendInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        handleAddFriend();
      }
    });

    postInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        handleAddPost();
      }
    });

    chatSendBtn.addEventListener('click', handleSendMessage);
    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        handleSendMessage();
      }
    });

    feedSearchInput.addEventListener('input', applyFeedFilter);
    feedSearchClearBtn.addEventListener('click', () => {
      feedSearchInput.value = '';
      applyFeedFilter();
    });
    feedFilterSelect.addEventListener('change', applyFeedFilter);

    adminMuteBtn.addEventListener('click', adminMute);
    adminUnmuteBtn.addEventListener('click', adminUnmute);
    adminCleanupBtn.addEventListener('click', adminCleanupUsers);

    (async function init() {
      const savedUser = localStorage.getItem(STORAGE_KEY_CURRENT);
      if (savedUser) {
        currentUser = savedUser;
      }
      renderAuthState();
      if (currentUser) {
        await fetchAndRenderPosts();
        await fetchFeed();
        await fetchDialogs();
        await fetchFriends();
        showSection('news');
      }
    })();
  </script>
</body>
</html>
